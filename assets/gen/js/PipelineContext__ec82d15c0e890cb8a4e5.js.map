{"version":3,"sources":["./src/ui/PipelineContext/PipelineContext.ts"],"names":[],"mappings":"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","file":"PipelineContext__ec82d15c0e890cb8a4e5.js","sourcesContent":["import * as _ from 'underscore';\nimport { IBuildingQueryEventArgs, QueryEvents } from '../../events/QueryEvents';\nimport { exportGlobally } from '../../GlobalExports';\nimport { $$ } from '../../utils/Dom';\nimport { Utils } from '../../utils/Utils';\nimport { Component } from '../Base/Component';\nimport { IComponentBindings } from '../Base/ComponentBindings';\nimport { ComponentOptions } from '../Base/ComponentOptions';\nimport { Initialization } from '../Base/Initialization';\nimport { Context, IPipelineContextProvider } from './PipelineGlobalExports';\n\ndeclare const Coveo;\n\nexport interface IPipelineContextOptions {}\n\n/**\n * The `PipelineContext` component injects custom contextual information into the search requests and usage analytics search events sent from a search interface.\n *\n * This component is meant to be initialized on a `script` HTML tag whose `type` attribute is set to `text/context` and whose optional JSON content defines the custom information to send (each value can be set to a string or array of strings).\n *\n * See [Sending Custom Context Information](https://docs.coveo.com/en/399/).\n * Note: To customize the context sent on all usage analytics events, see [Sending Custom Metadata with Search, Click, or Custom Events](https://docs.coveo.com/en/2004/javascript-search-framework/sending-custom-metadata-with-search-click-or-custom-events).\n */\nexport class PipelineContext extends Component implements IPipelineContextProvider {\n  static ID = 'PipelineContext';\n  static CURRENT_URL = 'CurrentUrl';\n\n  static doExport = () => {\n    exportGlobally({\n      PipelineContext: PipelineContext\n    });\n  };\n\n  private contextContent: Context = {};\n\n  public constructor(public element: HTMLElement, public options?: IPipelineContextOptions, public bindings?: IComponentBindings) {\n    super(element, PipelineContext.ID, bindings);\n    this.options = ComponentOptions.initComponentOptions(element, PipelineContext, options);\n    this.setContext(\n      $$(this.element)\n        .text()\n        .trim()\n    );\n    this.bind.onRootElement(QueryEvents.buildingQuery, (args: IBuildingQueryEventArgs) => this.handleBuildingQuery(args));\n  }\n\n  /**\n   * **Available since the [December 2017 Release](https://docs.coveo.com/en/373).**\n   *\n   * Sets a new context, replacing the previous context if applicable.\n   *\n   * @param newContext The new context to set, which can be directly passed as a JSON, or as a stringified JSON.\n   */\n  public setContext(newContext: string | Context) {\n    if (_.isString(newContext)) {\n      const contextParsed = this.tryParseContextFromString(newContext);\n      this.contextContent = contextParsed;\n    } else {\n      this.contextContent = newContext;\n    }\n  }\n\n  /**\n   * Returns the current context\n   */\n  public getContext(): Context {\n    const keys = this.getContextKeys();\n    return _.object(keys, _.map(keys, key => this.getContextValue(key)));\n  }\n\n  /**\n   * **Available since the [December 2017 Release](https://docs.coveo.com/en/373).**\n   *\n   * Sets a value for a context key, replacing the previous value if applicable.\n   * @param contextKey\n   * @param contextValue\n   */\n  public setContextValue(contextKey: string, contextValue: string | string[]) {\n    this.contextContent[contextKey] = contextValue;\n  }\n\n  /**\n   * Return all the context keys configured for context.\n   * @returns {string[]}\n   */\n  public getContextKeys(): string[] {\n    return _.keys(this.contextContent);\n  }\n\n  /**\n   * Get the context value associated to the given key.\n   *\n   * If the global variable Coveo.context contains the requested key, this method will return the value contained in Coveo.context instead of the one contained internally.\n   *\n   * This is especially useful in a Coveo for Salesforce context, where context values can be extracted from a backend service.\n   * @param key\n   * @returns {string}\n   */\n  public getContextValue(key: string): string | string[] {\n    const contextValue = this.contextContent[key];\n    if (_.isArray(contextValue)) {\n      const contextValues = [];\n      _.each(this.contextContent[key], value => {\n        contextValues.push(this.getModifiedData(value));\n      });\n      return contextValues;\n    } else if (_.isString(contextValue)) {\n      return this.getModifiedData(contextValue);\n    }\n    return '';\n  }\n\n  private handleBuildingQuery(args: IBuildingQueryEventArgs) {\n    let keys = this.getContextKeys();\n    _.each(keys, (key: string) => {\n      args.queryBuilder.addContextValue(key, this.getContextValue(key));\n    });\n  }\n\n  private tryParseContextFromString(contextAsString: string): Context {\n    if (_.isEmpty(contextAsString)) {\n      return {};\n    }\n    try {\n      // Context could be HTML encoded (eg: Coveo for Salesforce)\n      return JSON.parse(Utils.decodeHTMLEntities(contextAsString));\n    } catch (e) {\n      try {\n        return JSON.parse(contextAsString);\n      } catch (e) {\n        this.logger.error(`Error while trying to parse context from the PipelineContext component`, e);\n        return null;\n      }\n    }\n  }\n\n  private getModifiedData(value: string) {\n    /* We need to modify the data to escape special salesforce characters. eg: {! }\n     If we find the matching value in the global Coveo.context variable, we return that one instead of the one present locally.\n     So, concretely, the component could contain : \n     {\n       \"productName\" : \"{! productValueFromSalesforce }\"\n     }\n\n     This means that in those case, we would try to access Coveo.context.productValueFromSalesforce (which would in theory be a \"real\" product value from salesforce, and not a placeholder/variable)\n    */\n    return value.replace(/\\{\\!([^\\}]+)\\}/g, (all: string, contextKey: string) => {\n      const trimmedKey = contextKey.trim();\n      if (Coveo.context && trimmedKey in Coveo.context) {\n        return Coveo.context[trimmedKey];\n      } else if (trimmedKey == PipelineContext.CURRENT_URL) {\n        return window.location.href;\n      }\n      return '';\n    });\n  }\n}\n\nInitialization.registerAutoCreateComponent(PipelineContext);\n\n\n\n// WEBPACK FOOTER //\n// ./src/ui/PipelineContext/PipelineContext.ts"],"sourceRoot":""}